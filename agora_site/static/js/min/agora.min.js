void 0===window.gettext&&(window.gettext=function(text){return text}),function(){var Agora=this.Agora={},app=this.app={};Agora.TopView=Backbone.View.extend({el:"#top-bar",events:{},initialize:function(){_.bindAll(this)}}),Agora.MainView=Backbone.View.extend({el:"body",events:{"click a.action-form-link":"onActionFormLinkClicked"},initialize:function(){_.bindAll(this),$(document).ajaxStop(this.updateUi),this.updateUi(),this.setMomentLang(),this.topBar=new Agora.TopView},updateUi:function(){},setMomentLang:function(){moment.lang(this.$el.data("lang"))},onActionFormLinkClicked:function(event){event.preventDefault();var target=$(event.currentTarget);this.$("#post-action-form").attr("action",target.attr("href")),this.$("#post-action-form").submit()}}),app.main=new Agora.MainView,Agora.MessagesBox=Backbone.View.extend({el:"#messages-box",initialize:function(){var modal=this.$(".modal");modal.length>0&&this.$(".modal").modal("show")}}),app.messages=new Agora.MessagesBox,Agora.round2decimals=function(num){return Math.round(100*num)/100}}.call(this);var Ajax=Backbone.View.extend({initialize:function(){_.bindAll(this)},setContext:function(ctx){this.ctx=ctx},get:function(url,data,type){return this.request("GET",url,data,type)},post:function(url,data,type){return this.request("POST",url,data,type)},put:function(url,data,type){return this.request("PUT",url,data,type)},"delete":function(url,data,type){return this.request("DELETE",url,data,type)},request:function(type,url,data,dataType){var ajax_data={url:url,dataType:dataType||"text",type:type};return void 0!==data&&(ajax_data.data=data),this.options.contentType&&(ajax_data.contentType=this.options.contentType),this.options.headers&&(ajax_data.headers=this.options.headers),ajax_data.complete=this.requestComplete,$.ajax(ajax_data)},requestComplete:function(jxhr,stat){this.trigger("success",jxhr,stat,this.ctx)}});$.ajaxSetup({beforeSend:function(xhr,settings){function getCookie(name){var cookieValue=null;if(document.cookie&&""!=document.cookie)for(var cookies=document.cookie.split(";"),i=0;i<cookies.length;i++){var cookie=jQuery.trim(cookies[i]);if(cookie.substring(0,name.length+1)==name+"="){cookieValue=decodeURIComponent(cookie.substring(name.length+1));break}}return cookieValue}/^http:.*/.test(settings.url)||/^https:.*/.test(settings.url)||xhr.setRequestHeader("X-CSRFToken",getCookie("csrftoken"))}}),function(){var Charts=this.Charts={};Charts.grad=Math.PI/180,Charts.arc=function(data,node,selector,key_selector,color,width,height){function sweep(a){var i=d3.interpolate({startAngle:-90*Charts.grad,endAngle:-90*Charts.grad},a);return function(t){return arc(i(t))}}var radius=Math.min(width,height),pie=d3.layout.pie().sort(null).value(function(d){return selector(d)}).startAngle(-90*Charts.grad).endAngle(90*Charts.grad),arc=d3.svg.arc().innerRadius(radius-150).outerRadius(radius-40),arc2=d3.svg.arc().innerRadius(radius-150).outerRadius(radius-5),svg=d3.select(node).append("svg").attr("width",width).attr("height",height).append("g").attr("transform","translate("+width/2+","+height+")"),g=svg.selectAll(".arc").data(pie(data)).enter().append("g").attr("class","arc");g.append("path").attr("d",arc).attr("fill",function(d,i){return color(i)}).transition().duration(2e3).each("end",function(){d3.select(this).on("mouseover",Charts._arc_mouseover(this,arc2,key_selector)).on("mouseout",Charts._arc_mouseout(this,arc))}).attrTween("d",sweep)},Charts._arc_mouseover=function(o,arc2,key_selector){var obj=d3.select(o),key=key_selector(obj.data()[0].data),val=obj.data()[0].value,svg=d3.select("svg");return svg.attr("width"),svg.attr("height"),function(){obj.transition().attr("d",arc2).duration(200),d3.select("g").append("text").attr("class","textg").attr("dy","-4em").attr("text-anchor","middle").style("font","300 24px Sans Serif").text(key),d3.select("g").append("text").attr("class","textg").attr("dy","-1em").attr("text-anchor","middle").style("font","700 24px Sans Serif").text(val)}},Charts._arc_mouseout=function(o,arc){var obj=d3.select(o);return function(){obj.transition().attr("d",arc).duration(500),d3.selectAll(".textg").remove()}}}.call(this),function(){var Agora=this.Agora;this.app,function(){var ElectionModel=Backbone.Model.extend({}),ElectionsCollection=Backbone.Collection.extend({model:ElectionModel});Agora.CalendarWidgetView=Backbone.View.extend({el:"#agora-calendar",events:{"keyup .election-search-query":"onSearchChange"},initialize:function(){_.bindAll(this),this.template=_.template($("#template-election").html()),this.collection=new ElectionsCollection,this.collection.on("reset",this.resetCollection);var ajax=new Ajax;ajax.on("success",this.initializeSuccess),ajax.get(this.$el.data("url")),this.onSearchChange=_.debounce(this.onSearchChange,400)},initializeSuccess:function(xhr){if(200===xhr.status){var data=JSON.parse(xhr.responseText);this.collection.reset(data.objects)}},onSearchChange:function(event){var target=$(event.currentTarget),data={q:target.val()},ajax=new Ajax;ajax.on("success",this.initializeSuccess),ajax.get(this.$el.data("url"),data),console.log("onSearchChange: "+target.val())},resetCollection:function(collection){this.$(".list-container").empty();var data=collection.groupBy(function(item){var date=item.get("voting_extended_until_date")||item.get("voting_ends_at_date")||item.get("voting_starts_at_date");return date?date.split("T")[0]:null});_.each(_.pairs(data),function(item){var key=item[0],val=item[1],date=moment(key),dom=this.template({datetime:date.format("LL"),items:val});this.$(".list-container").append(dom)},this),0===collection.length&&this.$(".list-container").append(this.$("#no-elections"))}})}.call(this),function(){var AgoraModel=Backbone.Model.extend({}),AgorasCollection=Backbone.Collection.extend({model:AgoraModel});Agora.AgoraWidgetListView=Backbone.View.extend({el:"#agora-list",initialize:function(){_.bindAll(this),this.agoraTemplate=_.template($("#template-agora").html()),this.agorasCollection=new AgorasCollection,this.agorasCollection.on("reset",this.resetAgorasCollection);var ajax=new Ajax;ajax.on("success",this.initializeSuccess),ajax.get(this.$el.data("url"))},initializeSuccess:function(xhr){if(200===xhr.status){var data=JSON.parse(xhr.responseText);this.agorasCollection.reset(data.objects)}},resetAgorasCollection:function(collection){if(this.$(".last-agoras .list-container").empty(),0===collection.length){var emptyItem=this.make("ul",{id:"no-agoras"},gettext("No agoras found"));this.$(".last-agoras .list-container").append(emptyItem)}else collection.each(this.addAgoraItem)},addAgoraItem:function(model){var dom=this.agoraTemplate(model.toJSON());this.$(".last-agoras .list-container").append(dom)}})}.call(this),function(){var ItemModel=Backbone.Model.extend({}),ItemCollection=Backbone.Collection.extend({model:ItemModel});Agora.GenericListView=Backbone.View.extend({el:"#activity-list",events:{"click a.endless_more":"onMoreClicked"},setup:function(){this.url=this.$el.data("url"),this.method=this.$el.data("method")||"get"},setupTemplates:function(){void 0!==this.templateEl&&(this.template=_.template($(this.templateEl).html()))},initialize:function(){_.bindAll(this),this.firstLoadSuccess=!1,this.finished=!1,this.collection=new ItemCollection,this.collection.on("reset",this.collectionReset),this.collection.on("add",this.addItem),this.endlessDom=this.$(".endless-container"),this.endlessDom.find("div.endless_loading").hide(),this.offset=0,this.limit=20,this.setup(),this.setupTemplates(),this.requestObjects(),$(window).scroll(this.infiniteScroll)},requestObjects:function(){if(!this.finished){var ajax=new Ajax;ajax.on("success",this.requestSuccess);var params=_.extend({},{limit:this.limit,offset:this.offset},this.params||{});this.offset+=this.limit,"get"===this.method?ajax.get(this.url,params):"post"===this.method&&ajax.post(this.url,params)}},setEndlessFinishDom:function(){this.endlessDom.find("a.endless_more").replaceWith(gettext("<span>No more results</span>")),this.endlessDom.find("div.endless_loading").hide()},requestSuccess:function(xhr){if(200===xhr.status){var data=JSON.parse(xhr.responseText);if(this.endlessDom.find("div.endless_loading").hide(),0===data.objects.length)this.setEndlessFinishDom(),this.finished=!0;else{var doc=$(document),win=$(window);this.firstLoadSuccess?(this.$("a.endless_more").show(),_.each(data.objects,function(item){this.collection.add(item)},this)):(this.firstLoadSuccess=!0,this.collection.reset(data.objects)),this.endlessDom.appendTo(this.$el),data.objects.length<this.limit?(this.setEndlessFinishDom(),this.finished=!0):doc.height()==win.height()&&0==win.scrollTop()&&(this.$("a.endless_more").click(),this.$("a.endless_more").hide(),this.endlessDom.find("div.endless_loading").show())}}},collectionReset:function(collection){this.$el.empty(),collection.each(this.addItem)},renderItem:function(model){return void 0!==this.template?this.template(model.toJSON()):"<div>REIMPLEMENT THIS</div>"},addItem:function(model){var html=this.renderItem(model);this.$el.append(html)},infiniteScroll:function(){var doc=$(document),win=$(window),margin=this.$el.data("margin")||300;!this.finished&&doc.height()-win.height()-win.scrollTop()<=margin&&(this.$("a.endless_more").click(),this.$("a.endless_more").hide(),this.endlessDom.find("div.endless_loading").show())},onMoreClicked:function(event){event.preventDefault(),this.requestObjects()}}),Agora.ActivityListView=Agora.GenericListView.extend({el:"#activity-list",setup:function(){this.url=this.$el.data("url"),this.method=this.$el.data("method")||"get",this.templates={}},renderItem:function(model){var json=model.toJSON();return json.actor.initials=Agora.getUserInitials(json.actor),this.templates[json.type_name]||(this.templates[json.type_name]=_.template($("#template-action_"+json.type_name).html()||"<#template-action_"+json.type_name+" not found>")),this.templates[json.type_name](json)}}),Agora.getUserInitials=function(json){if(json.full_name&&json.full_name!=json.username){var initials="",words=$.trim(json.full_name).split(" ");return _.each(words,function(word){var trimmed=$.trim(word);trimmed.length>0&&(initials+=word[0].toUpperCase())}),initials}return json.username[0].toUpperCase()}}.call(this)}.call(this),function(){var Agora=this.Agora;this.app,Agora.HomeActivtyList=Agora.ActivityListView.extend({points:[],collectionReset:function(collection){this.$el.empty(),collection.each(this.addItem),this.slideShowElement="#activity_items",this.DELAY_SPEED=4e3,this.xy=d3.geo.mercator(),this.geopath=d3.geo.path().projection(this.xy),this.states=d3.select("#home_worldmap_canvas").append("svg").append("g").attr("id","states"),this.currentSlide=0,this.slides=$("#activity-list > div"),this.interval=setInterval(this.nextSlide,this.DELAY_SPEED);var self=this;this.slides.each(function(){$(this).appendTo($(self.slideShowElement))}),d3.json("/static/js/world-countries.json",function(collection){self.xy.scale(320);var translate=self.xy.translate();translate[0]=160,translate[1]=110,self.xy.translate(translate),self.states.selectAll("path").data(collection.features).enter().append("path").attr("d",self.geopath),self.slides.each(function(){self.geolocateElement($(this))})})},nextSlide:function(){this.currentSlide>=this.slides.length-1?this.currentSlide=0:this.currentSlide++,$(this.slideShowElement+" > div").first().removeClass("activity-action-first");var newElement=$(this.slides[this.currentSlide]).clone().addClass("activity-action-first").hide();newElement.prependTo($(this.slideShowElement)),newElement.animate({height:"toggle",opacity:"toggle"},"slow"),$(this.slideShowElement+" > div").last().remove(),this.geolocateElement(newElement),null!=this.interval&&clearInterval(this.interval),this.interval=setInterval(this.nextSlide,this.DELAY_SPEED)},geolocateElement:function(element){var geodata=element.attr("geodata");if(geodata.length>0){geodata=geodata.substr(1,geodata.length-2),geodata=geodata.split(",");var pos=[parseFloat(geodata[1]),parseFloat(geodata[0])];this.geolocate(pos)}},geolocate:function(pos){function animateSecondStep(){self.points.push(this)}pos=this.xy(pos);var point=this.points.pop();point&&d3.select(point).transition().duration(100).style("fill-opacity","0").each("end",function(){d3.select(this).remove()});var self=this;d3.select("#home_worldmap_canvas svg").append("svg:circle").style("fill-opacity","0.1").style("fill","red").attr("r",10).attr("cx",pos[0]).attr("cy",pos[1]).transition().delay(0).duration(1e3).attr("r",1.5).style("fill-opacity","1").each("end",animateSecondStep)}}),Agora.HomeAnonymousView=Backbone.View.extend({el:"body",initialize:function(){_.bindAll(this),$("#activity-list").length>0&&(this.activityListView=new Agora.HomeActivtyList)}})}.call(this),function(){var Agora=this.Agora;this.app,Agora.HomeView=Backbone.View.extend({el:"div.home",initialize:function(){_.bindAll(this),this.calendarView=new Agora.CalendarWidgetView,this.agoralistView=new Agora.AgoraWidgetListView,this.activityListView=new Agora.ActivityListView}})}.call(this),function(){var Agora=this.Agora;this.app,Agora.TalliedElectionsView=Backbone.View.extend({el:"#tallied_elections_view",initialize:function(){return _.bindAll(this),this.template=_.template($("#template-tallied_elections_view").html()),this.render(),this.$el},render:function(){for(var i=0;i<ajax_data.tallied_elections.objects.length;i++){var election=ajax_data.tallied_elections.objects[i];if(election.result.is_simple=!1,election.result.participation_percentage=Agora.round2decimals(100*election.result.total_votes/election.result.electorate_count),1==election.result.counts.length&&"question/result/ONE_CHOICE"==election.result.counts[0].a)for(var winner=election.result.counts[0].winners[0],answers=election.result.counts[0].answers,j=0;j<answers.length;j++)if(answers[j].value==winner){election.result.winner_data=answers[j],election.result.winner_data.total_count_percentage=Agora.round2decimals(election.result.winner_data.total_count_percentage),election.result.is_simple=!0;break}}return this.$el.html(this.template(ajax_data.tallied_elections)),this.delegateEvents(),this}}),Agora.AgoraView=Backbone.View.extend({el:"div.agora",initialize:function(){_.bindAll(this),this.calendarView=new Agora.CalendarWidgetView,$("#activity-list").length>0&&(this.activityListView=new Agora.ActivityListView,this.talliedElectionsView=new Agora.TalliedElectionsView)}})}.call(this),function(){var AgoraInfiniteView=Agora.GenericListView.extend({el:"#activity-list",templateEl:"#template-search-agora-item"});Agora.AgoraListView=Backbone.View.extend({el:"div.search",initialize:function(){_.bindAll(this),this.infiniteListView=new AgoraInfiniteView}})}.call(this),function(){var AgoraUserInfiniteView=Agora.GenericListView.extend({el:"#user-list",templateEl:"#template-agora-profile-item",events:{"click .user-result .row":"clickUser"},renderItem:function(model){var json=model.toJSON();return json.agora_id=this.$el.data("agora-id"),json.agora_path=this.$el.data("agora-path"),json.initials=Agora.getUserInitials(json),this.template(json)},clickUser:function(e){if(!$(e.target).closest("a")){var url=$(e.target).closest(".row").data("url");window.location.href=url}}});Agora.AgoraUserListView=Backbone.View.extend({el:"div.search",initialize:function(){_.bindAll(this),this.infiniteListView=new AgoraUserInfiniteView}})}.call(this),function(){var Agora=this.Agora;this.app,Agora.QuestionListView=Backbone.View.extend({tagName:"div",initialize:function(){return _.bindAll(this),this.template=_.template($("#template-question_list_view").html()),this.render(),this.$el},render:function(){this.$el.html(this.template(ajax_data)),$("#question-list").append(this.$el),$("#question-list table tbody").each(function(){var randomize=$(this).data("randomize");randomize&&$(this).shuffle()})}}),Agora.ElectionResultsView=Backbone.View.extend({tagName:"div",initialize:function(){return _.bindAll(this),this.template=_.template($("#template-election_results_view").html()),this.render(),this.$el},render:function(){this.$el.html(this.template(ajax_data)),$("#election-results").append(this.$el);for(var i=0;i<ajax_data.election.result.counts.length;i++){var view=null;"MEEK-STV"==ajax_data.election.result.counts[i].tally_type?view=new Agora.MeekStvTallyView({question:ajax_data.election.result.counts[i],tally:ajax_data.extra_data.tally_log[i],question_num:i}):"ONE_CHOICE"==ajax_data.election.result.counts[i].tally_type&&(view=new Agora.OneChoiceTallyView({question:ajax_data.election.result.counts[i],tally:ajax_data.extra_data.tally_log[i],question_num:i})),$("#election-results").append(view.render().el)}}}),Agora.MeekStvTallyView=Backbone.View.extend({tagName:"div",id:function(){return"tally_question"+this.options.question_num},initialize:function(){return _.bindAll(this),this.template=_.template($("#template-question_meek_stv_tally").html()),this.render(),this.$el},render:function(){return this.$el.html(this.template(this.options)),this.$el.find("tbody tr").sortElements(function(a,b){var rate=function(i){return $(i).find(".already_won").length+$(i).find(".won").length-$(i).find(".lost").length-$(i).find(".already_lost").length};return rate(a)<rate(b)}),this}}),Agora.OneChoiceTallyView=Backbone.View.extend({tagName:"div",id:function(){return"tally_question"+this.options.question_num},className:"election-results",initialize:function(){return _.bindAll(this),this.color=d3.scale.category10(),this.template=_.template($("#template-question_one_choice_tally").html()),this.render(),this.$el},render:function(){for(var i=0;i<this.options.question.answers.length;i++)this.options.question.answers[i].color=this.color(i);return this.$el.html(this.template(this.options)),this.$el.find("li").sortElements(function(a,b){var rate=function(i){return parseFloat($(i).data("value"))};return rate(a)<rate(b)}),this.pieChart(),this},pieChart:function(){var pienode=this.$el.find(".piechart")[0];Charts.arc(this.options.question.answers,pienode,function(d){return d.total_count},function(d){return d.value},this.color,500,250)}}),Agora.ElectionView=Backbone.View.extend({el:"div.election",initialize:function(){_.bindAll(this),$("#activity-list").length>0&&(this.activityListView=new Agora.ActivityListView),this.questionListView=new Agora.QuestionListView,ajax_data.election.result_tallied_at_date&&(this.electionResultsView=new Agora.ElectionResultsView)}}),Agora.ElectionDelegatesView=Agora.GenericListView.extend({el:"#user-list",templateEl:"#template-vote_list_item",templateVoteInfoEl:"#template-vote_info",events:{"click .user-result .row":"clickUser","hover .user-result .row":"hoverUser"},renderItem:function(model){return this.template(model.toJSON())},hoverUser:function(e){this.templateVoteInfo||(this.templateVoteInfo=_.template($(this.templateVoteInfoEl).html()));var id=$(e.target).closest(".row").data("id"),model={vote:this.collection.get(id).toJSON(),election:ajax_data.election,extra_data:ajax_data.extra_data};if(model.election.result_tallied_at_date){model.num_delegated_votes=ajax_data.extra_data.delegation_counts[model.vote.voter.id]?ajax_data.extra_data.delegation_counts[model.vote.voter.id]:0;var size=_.size(ajax_data.extra_data.delegation_counts),filtered=_.filter(ajax_data.extra_data.delegation_counts,function(val){return val<=model.num_delegated_votes});model.rank_in_delegates=size-filtered.length+1}$("#vote_info").html(this.templateVoteInfo(model))},clickUser:function(){}})}.call(this),function(){var ElectionInfinteView=Agora.GenericListView.extend({el:"#activity-list",templateEl:"#template-search-election-item",renderItem:function(model){var json=model.toJSON();return json.election_at=interpolate(gettext("%(electionname)s at %(agora_full_name)s"),{electionname:json.pretty_name,agora_full_name:json.agora.full_name},!0),this.template(json)}});Agora.ElectionListView=Backbone.View.extend({el:"div.search",initialize:function(){_.bindAll(this),this.infiniteListView=new ElectionInfinteView}})}.call(this),function(){var Agora=this.Agora;this.app,function(){var SearchInfiniteView=Agora.GenericListView.extend({el:"#activity-list",templateEl:"#template-search-item",setup:function(){Agora.GenericListView.prototype.setup.apply(this),this.params={q:this.$el.data("query")},this.templates={},ctypes=["agora","election","profile"];for(var i=0;i<ctypes.length;i++){var templateEl="#template-search-"+ctypes[i]+"-item";this.templates[ctypes[i]]=_.template($(templateEl).html())}},renderItem:function(model){this.templateEl;var ctype=model.get("obj").content_type,template=this.templates[ctype],json=model.toJSON().obj;"profile"==ctype&&(json.initials=Agora.getUserInitials(json));var ret=template(json);return ret}});Agora.SearchListView=Backbone.View.extend({el:"div.search",initialize:function(){_.bindAll(this),this.infiniteListView=new SearchInfiniteView}})}.call(this)}.call(this),function(){var Agora=this.Agora;this.app,Agora.UserView=Backbone.View.extend({el:"div.user",initialize:function(){_.bindAll(this),$("#activity-list").length>0&&(this.activityListView=new Agora.ActivityListView),this.agoralistView=new Agora.AgoraWidgetListView}})}.call(this),function(){var UserInfiniteView=Agora.GenericListView.extend({el:"#user-list",templateEl:"#template-search-profile-item",renderItem:function(model){var json=model.toJSON();return json.initials=Agora.getUserInitials(json),this.template(json)}});Agora.UserListView=Backbone.View.extend({el:"div.search",initialize:function(){_.bindAll(this),this.infiniteListView=new UserInfiniteView}})}.call(this),function(){Agora.AnswerModel=Backbone.AssociatedModel.extend({defaults:{a:"ballot/answer",url:"",details:"",value:""}}),Agora.QuestionModel=Backbone.AssociatedModel.extend({relations:[{type:Backbone.Many,key:"answers",relatedModel:Agora.AnswerModel}],defaults:{a:"ballot/question",tally_type:"ONE_CHOICE",question_num:0,max:1,min:0,num_seats:1,question:"",randomize_answer_order:!0,answers:[]}}),Agora.ElectionModel=Backbone.AssociatedModel.extend({relations:[{type:Backbone.Many,key:"questions",relatedModel:Agora.QuestionModel}],defaults:{pretty_name:"",description:"",is_vote_secret:!0,questions:[],from_date:"",to_date:""}}),Agora.AnswerView=Backbone.View.extend({tagName:"tr",events:{"click td":"editValue","keyup .input-edit-value":"keyUpSaveValue"},initialize:function(){return _.bindAll(this),this.render(),this.listenTo(this.model,"destroy",this.remove),this.$el},render:function(){return this.template=_.template($("#template-election_form_question_answer").html()),this.$el.html(this.template(this.model.toJSON())),this.$el.find(".input-edit-value").focusout(this.focusOutValue),this},editValue:function(e){if(!$(e.target).hasClass("remove_option")){var val=this.$el.find(".the-value").html();this.$el.find(".input-edit-value").val(val),this.$el.find(".view-value").hide(),this.$el.find(".edit-value").show(),this.$el.find(".input-edit-value").focus()}},keyUpSaveValue:function(e){if(13==e.keyCode){var value=this.$el.find(".input-edit-value").val();if(!value)return this.$el.find(".view-value").show(),this.$el.find(".edit-value").hide(),void 0;this.model.set("value",value),this.$el.find(".the-value").html(value),this.$el.find(".view-value").show(),this.$el.find(".edit-value").hide()}else 27==e.keyCode&&(this.$el.find(".view-value").show(),this.$el.find(".edit-value").hide())},focusOutValue:function(){this.$el.find(".view-value").show(),this.$el.find(".edit-value").hide()}}),Agora.QuestionEditView=Backbone.View.extend({tagName:"div",className:"tab-pane",events:{"click .dropdown-menu li a":"selectVotingSystem","click .add_option_btn":"userAddAnswer","keyup .add_option":"userAddAnswerEnter","click .remove_option":"userRemoveAnswer"},getMetrics:function(){var self=this,checkNumWinners=function(val){var num_answers=self.model.get("answers").length;return 2>num_answers?!0:num_answers>val},checkMax=function(val){var num_answers=self.model.get("answers").length;return 2>num_answers?!0:num_answers>val},checkNumAnswers=function(){var num_answers=self.model.get("answers").length;return num_answers>=2};return[[".name","presence",gettext("This field is required")],[".name","between:4:140",gettext("Must be between 4 and 140 characters long")],[".num_winners","presence",gettext("This field is required")],[".min_num_choices","presence",gettext("This field is required")],[".max_num_choices","presence",gettext("This field is required")],[".num_winners","integer",gettext("This field must be an integer")],[".min_num_choices","integer",gettext("This field must be an integer")],[".max_num_choices","integer",gettext("This field must be an integer")],[".num_winners",checkNumWinners,gettext("Invalid value")],[".min_num_choices",checkMax,gettext("Invalid value")],[".add_option",checkNumAnswers,gettext("Add at least two choices")]]},id:function(){return"question-tab-"+this.model.get("question_num")},updateModel:function(){this.model.set("question",this.$el.find(".name").val()),this.model.set("num_seats",parseInt(this.$el.find(".num_winners").val())),this.model.set("min",parseInt(this.$el.find(".min_num_choices").val())),this.model.set("max",parseInt(this.$el.find(".max_num_choices").val()))},initialize:function(){return _.bindAll(this),this.template=_.template($("#template-election_form_question_tab_pane").html()),this.model.questionView=this,this.render(),this.listenTo(this.model.get("answers"),"add",this.addAnswer),this.listenTo(this.model.get("answers"),"remove",this.removeAnswer),this.listenTo(this.model.get("answers"),"reset",this.resetAnswers),this.listenTo(this.model,"destroy",this.remove),this.listenTo(this.model,"change:question_num",this.render),this.listenTo(this.model.get("answers"),"change:value",this.answerChanged),this.$el},render:function(){var json=this.model.toJSON();this.$el.html(this.template(json)),this.$el.attr("id",this.id);var self=this;return this.$el.find(".votingsystem-dropdown li").each(function(){var id=$(this).data("id");if(id==self.$el.find(".votingsystem").data("id")){var usertext=$(this).data("usertext");self.$el.find(".votingsystem").html(usertext),"MEEK-STV"==id?self.$el.find(".num_winners_opts").css("display","inline-block"):(self.$el.find(".num_winners_opts").hide(),self.$el.find(".max_num_choices").attr("readonly","readonly"))}}),this.resetAnswers(),this.$el.find("form").nod(this.getMetrics()),this.$el.find("form").submit(this.createQuestion),this},userRemoveAnswer:function(e){var value=$(e.target).closest("a").data("value"),model=this.model.get("answers").find(function(answer){return answer.get("value")==value});this.model.get("answers").remove(model),model.destroy()},userAddAnswerEnter:function(e){13==e.keyCode&&(this.userAddAnswer(),e.preventDefault())},userAddAnswer:function(){var val=this.$el.find(".add_option").val();if(val){var model=this.model.get("answers").find(function(answer){return answer.get("value")==val});if(!model){this.$el.find(".add_option").val("");var newAnswer=new Agora.AnswerModel({value:val});this.model.get("answers").add(newAnswer)}}},addAnswer:function(answerModel){var view=new Agora.AnswerView({model:answerModel});this.$el.find(".option-list").append(view.render().el),this.model.get("answers").length>0&&this.$el.find(".atleastwooptions").hide()},removeAnswer:function(){this.model.get("answers").length<1&&this.$el.find(".atleastwooptions").show()},answerChanged:function(answer){var answers=this.model.get("answers").filter(function(answer2){return answer.get("value")==answer2.get("value")});answers.length>1&&answer.destroy()},resetAnswers:function(){this.$el.find(".option-list").empty(),this.model.get("answers").each(this.addAnswer)},resetForm:function(){this.stopListening(),this.model.clear().set(this.model.defaults),this.initialize()},selectVotingSystem:function(e){var id=$(e.target).closest("li").data("id"),usertext=$(e.target).closest("li").data("usertext");this.$el.find(".votingsystem").data("id",id),this.$el.find(".votingsystem").html(usertext),"MEEK-STV"==id?(this.$el.find(".num_winners_opts").css("display","inline-block"),this.$el.find(".max_num_choices").removeAttr("readonly")):(this.$el.find(".num_winners_opts input").val("1"),this.$el.find(".num_winners_opts").hide(),this.$el.find(".max_num_choices").val("1"),this.$el.find(".max_num_choices").attr("readonly","readonly")),this.model.set("tally_type",id)},createQuestion:function(e){return e.preventDefault(),this.model.formValid=!0,!1}}),Agora.ElectionCreateForm=Backbone.View.extend({el:"div.top-form",initData:{},getMetrics:function(){var self=this,checkIntervalDate=function(){if(0==self.$el.find("#schedule_voting:checked").length)return!0;var val_end=self.$el.find("#end_voting_date").val(),end_date=moment(val_end,"MM/DD/YYYY HH:mm"),val_start=self.$el.find("#start_voting_date").val(),start_date=moment(val_start,"MM/DD/YYYY HH:mm");return null!=end_date&&null!=start_date&&end_date-start_date>=36e5};return[["#pretty_name","presence",gettext("This field is required")],["#pretty_name","between:4:140",gettext("Must be between 4 and 140 characters long")],["#description","presence",gettext("This field is required")],["#description","min-length:4",gettext("Must be at least 4 characters long")],["[name=is_vote_secret]","presence",gettext("You must choose if vote is secret")],["#start_voting_date",checkIntervalDate,gettext("Invalid dates")],["#end_voting_date",checkIntervalDate,gettext("Invalid dates")]]},events:{"click #schedule_voting":"toggleScheduleVoting","click #show_add_question_tab_btn":"showAddQuestionTab","click #schedule_voting_label":"checkSchedule","click .create_question_btn":"createQuestion","click .remove_question_btn":"removeQuestion"},getInitModel:function(){return new Agora.ElectionModel},modelToJsonForTemplate:function(){var json=this.model.toJSON();return json.edit_election=!1,json},initialize:function(){this.template=_.template($("#template-election_form").html()),this.templateNavtab=_.template($("#template-election_form_question_navtab").html()),_.bindAll(this),this.model=this.getInitModel(),this.$el.html(this.template(this.modelToJsonForTemplate())),this.addQuestionView=new Agora.QuestionEditView({model:new Agora.QuestionModel({question_num:0})}),this.$el.find(".tab-content").append(this.addQuestionView.render().el),this.listenTo(this.model.get("questions"),"add",this.addQuestion),this.model.get("questions").each(this.addQuestion),this.listenTo(this.model,"change",this.updateButtonsShown),this.listenTo(this.model.get("questions"),"add",this.updateButtonsShown),this.listenTo(this.model.get("questions"),"remove",this.updateButtonsShown),this.updateButtonsShown(),this.$el.find("#create_election_form").nod(this.getMetrics()),$(".datetimepicker").datetimepicker(),this.model.get("from_date")&&(this.$el.find("#schedule_voting").click(),$("div.top-form #schedule_voting_controls").toggle()),$("#create_election_form").submit(this.saveElection)},removeQuestion:function(e){var question_num=$(e.target).data("id"),question=this.model.get("questions").at(question_num-1),length=this.model.get("questions").length;question.destroy(),this.model.get("questions").remove(question),this.$el.find("#question-navtab-"+length).remove();var i=1;this.model.get("questions").each(function(model){model.set("question_num",i),i++});var selector="#add-question-navtab a";this.$el.find(selector).tab("show")},createQuestion:function(){if(this.addQuestionView.model.formValid=!1,this.addQuestionView.$el.find("[type=submit]").click(),this.addQuestionView.model.formValid){this.addQuestionView.updateModel();var model=this.addQuestionView.model.clone();model.set("question_num",this.model.get("questions").length+1),this.model.get("questions").add(model),this.addQuestionView.resetForm()}},checkSchedule:function(e){0==$("#schedule_voting:checked").length&&$(e.target).closest(".error").removeClass("error")},addQuestion:function(questionModel){var i=questionModel.get("question_num");this.$el.find("#add-question-navtab").before(this.templateNavtab({question_num:i}));var view=new Agora.QuestionEditView({model:questionModel});this.$el.find(".tab-content").append(view.render().el)
},toggleScheduleVoting:function(e){$("div.top-form #schedule_voting_controls").toggle(e.target.checked)},updateModel:function(){var start_date=this.$el.find("#start_voting_date").val(),end_date=this.$el.find("#end_voting_date").val();0==$("#schedule_voting:checked").length?(this.model.set("from_date",""),this.model.set("to_date","")):(this.model.set("from_date",new Date(start_date).toJSON()),this.model.set("to_date",new Date(end_date).toJSON())),this.model.set("pretty_name",this.$el.find("#pretty_name").val()),this.model.set("description",this.$el.find("#description").val()),this.model.set("short_description",this.model.get("description").substr(0,140));var is_vote_secret="checked"==$("#is_vote_secret_yes").attr("checked");this.model.set("is_vote_secret",is_vote_secret)},sendingData:!1,saveElection:function(e){if(e.preventDefault(),!this.sendingData){this.updateModel();var failingQuestion=this.model.get("questions").find(function(question){return question.formValid=!1,question.questionView.$el.find("[type=submit]").click(),0==question.formValid});if(failingQuestion){var question_num=failingQuestion.get("question_num"),selector="#question-navtab-"+question_num+" a";return this.$el.find(selector).tab("show"),void 0}this.$el.find("#create_election_btn").addClass("disabled"),this.sendingData=!0;var json=this.model.toJSON();json.action="create_election";var agora_id=$("#agora_id").val(),self=this;return $.ajax("/api/v1/agora/"+agora_id+"/action/",{data:JSON.stringifyCompat(json),contentType:"application/json",type:"POST"}).done(function(e){window.location.href=e.url}).fail(function(){self.sendingData=!1,self.$el.find("#create_election_btn").removeClass("disabled"),alert("Error creating the election")}),!1}},updateButtonsShown:function(){0==this.model.get("questions").length?(this.$el.find("#create_election_btn").hide(),this.$el.find("#save_election_btn").hide(),this.$el.find("#show_add_question_tab_btn").show()):(this.$el.find("#create_election_btn").show(),this.$el.find("#save_election_btn").show(),this.$el.find("#show_add_question_tab_btn").hide())},showAddQuestionTab:function(){this.$el.find(".nav-tabs a:last").tab("show")}}),Agora.ElectionEditForm=Agora.ElectionCreateForm.extend({getInitModel:function(){var from_date=moment(ajax_data.voting_starts_at_date),to_date=moment(ajax_data.voting_ends_at_date);from_date&&(from_date=from_date.format("MM/DD/YYYY HH:mm")),to_date&&(to_date=to_date.format("MM/DD/YYYY HH:mm"));var initData={id:ajax_data.id,pretty_name:ajax_data.pretty_name,description:ajax_data.description,comments_policy:ajax_data.comments_policy,is_vote_secret:ajax_data.is_vote_secret,questions:ajax_data.questions,from_date:from_date,to_date:to_date};return new Agora.ElectionModel(initData)},modelToJsonForTemplate:function(){var json=this.model.toJSON();return json.edit_election=!0,json},sendingData:!1,saveElection:function(e){if(e.preventDefault(),!this.sendingData){this.updateModel();var failingQuestion=this.model.get("questions").find(function(question){return question.formValid=!1,question.questionView.$el.find("[type=submit]").click(),0==question.formValid});if(failingQuestion){var question_num=failingQuestion.get("question_num"),selector="#question-navtab-"+question_num+" a";return this.$el.find(selector).tab("show"),void 0}this.$el.find("#save_election_btn").addClass("disabled"),this.sendingData=!0;var json=this.model.toJSON();json.from_date&&(json.from_date=new Date(json.from_date).toJSON()),json.to_date&&(json.to_date=new Date(json.to_date).toJSON());var election_id=this.model.get("id"),self=this;return $.ajax("/api/v1/election/"+election_id+"/",{data:JSON.stringifyCompat(json),contentType:"application/json",type:"PUT"}).done(function(e){window.location.href=e.url}).fail(function(){alert("Error saving the election")}).always(function(){self.sendingData=!1,self.$el.find("#save_election_btn").removeClass("disabled")}),!1}}})}.call(this),function(){Agora.VoteAnswerModel=Backbone.AssociatedModel.extend({defaults:{a:"ballot/answer",url:"",details:"",value:""}}),Agora.VoteQuestionModel=Backbone.AssociatedModel.extend({relations:[{type:Backbone.Many,key:"answers",relatedModel:Agora.VoteAnswerModel},{type:Backbone.Many,key:"user_answers",relatedModel:Agora.VoteAnswerModel}],defaults:{a:"ballot/question",tally_type:"ONE_CHOICE",question_num:0,max:1,min:0,num_seats:1,question:"",randomize_answer_order:!0,answers:[],user_answers:[]}}),Agora.VoteElectionModel=Backbone.AssociatedModel.extend({relations:[{type:Backbone.Many,key:"questions",relatedModel:Agora.VoteQuestionModel}],defaults:{pretty_name:"",description:"",is_vote_secret:!0,user_vote_is_secret:!0,questions:[],from_date:"",to_date:""},initialize:function(){var self=this;this.get("questions").each(function(element,index,list){element.set("question_num",index),element.set("num_questions",list.length),element.set("election_name",self.get("pretty_name"))})}}),Agora.VotingBooth=Backbone.View.extend({el:"#voting_booth",events:{"click .btn-start-voting":"startVoting"},reviewMode:!1,initialize:function(){return _.bindAll(this),this.template=_.template($("#template-voting_booth").html()),this.model=new Agora.VoteElectionModel(ajax_data),this.render(),this.$el},render:function(){this.$el.html(this.template(this.model.toJSON())),this.startScreenView=new Agora.VotingBoothStartScreen({model:this.model}),this.$el.find(".current-screen").append(this.startScreenView.render().el),this.questionViews=[];var self=this;return this.model.get("questions").each(function(element,index){self.questionViews[index]=self.createQuestionView(element)}),this.reviewQuestions=new Agora.ReviewQuestionsView({model:this.model,votingBooth:this}),this.voteCast=new Agora.VoteCastView({model:this.model,votingBooth:this}),this.delegateEvents(),this},createQuestionView:function(model){var voting_system=model.get("tally_type");return"ONE_CHOICE"==voting_system?new Agora.VotePluralityQuestion({model:model,votingBooth:this}):"MEEK-STV"==voting_system?new Agora.VoteRankedQuestion({model:model,votingBooth:this}):void 0},startVoting:function(){this.$el.find(".current-screen").html(""),this.$el.find(".current-screen").append(this.questionViews[0].render().el)},nextStep:function(question_num){var size=this.model.get("questions").length;return this.$el.find(".current-screen").html(""),question_num+1==size||this.reviewMode?(this.reviewMode=!0,this.$el.find(".current-screen").append(this.reviewQuestions.render().el),void 0):(this.$el.find(".current-screen").append(this.questionViews[question_num+1].render().el),void 0)},changeQuestionChoices:function(question_num){this.$el.find(".current-screen").html(""),this.$el.find(".current-screen").append(this.questionViews[question_num].render().el)},sendingData:!1,castVote:function(){if(!this.sendingData){this.sendingData=!0,$("#cast-ballot-btn").addClass("disabled");var user_vote_is_secret=0==this.$el.find("#user_vote_is_public:checked").length,ballot={is_vote_secret:user_vote_is_secret,action:"vote"};this.model.get("questions").each(function(element,index){var user_answers=element.get("user_answers").pluck("value"),voting_system=element.get("tally_type");"ONE_CHOICE"==voting_system?ballot["question"+index]=user_answers.length>0?user_answers[0]:"":"MEEK-STV"==voting_system&&(ballot["question"+index]=user_answers)});var election_id=this.model.get("id"),self=this;$.ajax("/api/v1/election/"+election_id+"/action/",{data:JSON.stringifyCompat(ballot),contentType:"application/json",type:"POST"}).done(function(){self.$el.find(".current-screen").html(""),self.$el.find(".current-screen").append(self.voteCast.render().el)}).fail(function(){self.sendingData=!1,self.$el.find("#cast-ballot-btn").removeClass("disabled"),alert("Error casting the ballot, try again or report this problem")})}}}),Agora.VotingBoothStartScreen=Backbone.View.extend({initialize:function(){return _.bindAll(this),this.template=_.template($("#template-voting_booth_start_screen").html()),this.$el},render:function(){this.$el.html(this.template(this.model.toJSON()));var converter=new Showdown.converter,self=this;return this.$el.find(".markdown-readonly").each(function(){var data_id=$(this).data("id");$(this).html(converter.makeHtml(self.model.get(data_id)))}),this.delegateEvents(),this}}),Agora.VotePluralityQuestion=Backbone.View.extend({events:{"click input":"selectChoice","click .remove-selection":"removeSelection","click .btn-continue":"continueClicked"},initialize:function(){return _.bindAll(this),this.template=_.template($("#template-voting_booth_question_plurality").html()),this.votingBooth=this.options.votingBooth,this.$el},render:function(){if(this.$el.html(this.template(this.model.toJSON())),this.model.get("randomize_answer_order")&&this.$el.find(".plurality-options").shuffle(),this.model.get("user_answers").length>0){var currentSelection=this.model.get("user_answers").at(0).get("value");this.$el.find("label input").each(function(){$(this).val()==currentSelection&&($(this).attr("checked","checked"),$(this).closest("label").addClass("active"))})}return this.delegateEvents(),this},selectChoice:function(e){this.$el.find("label.active").removeClass("active"),$(e.target).closest("label").addClass("active"),this.$el.find(".select-info").hide();var newSelection,value=$(e.target).val();this.model.get("answers").each(function(element){element.get("value")==value&&(newSelection=element.clone())}),this.model.get("user_answers").length>0&&this.model.get("user_answers").at(0).destroy(),this.model.get("user_answers").add(newSelection)},removeSelection:function(){this.$el.find("label.active input").prop("checked",!1),this.$el.find("label.active").removeClass("active"),this.model.get("user_answers").length>0&&this.model.get("user_answers").at(0).destroy()},continueClicked:function(){return 0==this.model.get("min")?(this.nextStep(),void 0):0==this.$el.find("label.active").length?(this.$el.find(".select-info").show(),void 0):(this.nextStep(),void 0)},nextStep:function(){this.votingBooth.nextStep(this.model.get("question_num"))}}),Agora.VoteRankedQuestion=Backbone.View.extend({events:{"click .available-choices li a":"selectChoice","click .btn-continue":"continueClicked"},initialize:function(){return _.bindAll(this),this.template=_.template($("#template-voting_booth_question_ranked").html()),this.templateChoice=_.template($("#template-voting_booth_question_ranked_choice").html()),this.votingBooth=this.options.votingBooth,this.$el},render:function(){this.$el.html(this.template(this.model.toJSON())),this.model.get("randomize_answer_order")&&this.$el.find(".available-choices ul").shuffle();var self=this,selection=[];return this.model.get("user_answers").each(function(element,index){var value=element.get("value"),target=null;self.$el.find(".available-choices ul li").each(function(){$(this).data("value")==value&&(target=this)}),selection[index]=target}),this.model.get("user_answers").reset(),_.each(selection,function(element){self.selectChoice({target:element})}),this.delegateEvents(),this},continueClicked:function(){var length=this.model.get("user_answers").length;return length<this.model.get("min")?(this.$el.find(".need-select-more").show(),void 0):(this.nextStep(),void 0)},selectChoice:function(e){var newSelection,liEl=$(e.target).closest("li"),value=liEl.data("value"),length=this.model.get("user_answers").length;if(this.model.get("answers").each(function(element){element.get("value")==value&&(newSelection=element.clone())}),liEl.hasClass("active")){liEl.removeClass("active"),liEl.find("i").addClass("icon-chevron-right"),liEl.find("i").removeClass("icon-chevron-left"),liEl.find("i").removeClass("icon-white");var userChoice=null;this.$el.find(".user-choices ul li").each(function(index){$(this).data("value")==value&&(userChoice=$(this)),userChoice&&$(this).find("small").html(index+".")}),userChoice.remove(),this.model.get("user_answers").each(function(element){element.get("value")==value&&element.destroy()}),length-1<this.model.get("max")&&this.$el.find(".cannot-select-more").hide()}else{if(length>=this.model.get("max"))return;liEl.addClass("active"),liEl.find("i").removeClass("icon-chevron-right"),liEl.find("i").addClass("icon-chevron-left"),liEl.find("i").addClass("icon-white");var templData={value:value,i:length+1},newChoiceLink=this.templateChoice(templData),newChoice=$(document.createElement("li"));newChoice.data("value",value),newChoice.html(newChoiceLink),this.$el.find(".user-choices ul").append(newChoice),this.model.get("user_answers").add(newSelection),length+1==this.model.get("min")&&this.$el.find(".need-select-more").hide(),length+1==this.model.get("max")&&this.$el.find(".cannot-select-more").show()}},nextStep:function(){this.votingBooth.nextStep(this.model.get("question_num"))}}),Agora.ReviewQuestionsView=Backbone.View.extend({events:{"click th a":"changeQuestionChoices","click #cast-ballot-btn":"continueClicked"},initialize:function(){return _.bindAll(this),this.template=_.template($("#template-voting_booth_review_questions").html()),this.votingBooth=this.options.votingBooth,this.$el},render:function(){return this.$el.html(this.template(this.model.toJSON())),this.delegateEvents(),-1==this.model.get("user_perms").indexOf("vote_counts")&&(this.$el.find("#user_vote_is_public").attr("checked","checked"),this.$el.find("#user_vote_is_public").attr("disabled",!0),this.$el.find("#user_vote_is_public").closest("label").find("span.optional").hide(),this.$el.find("#user_vote_is_public").closest("label").find("span.mandatory").removeClass("hide")),this},changeQuestionChoices:function(e){this.votingBooth.changeQuestionChoices($(e.target).data("id"))},continueClicked:function(){this.votingBooth.castVote()}}),Agora.VoteCastView=Backbone.View.extend({events:{},initialize:function(){return _.bindAll(this),this.template=_.template($("#template-voting_booth_vote_cast").html()),this.votingBooth=this.options.votingBooth,this.$el},render:function(){return this.$el.html(this.template(this.model.toJSON())),this.delegateEvents(),this}})}.call(this);